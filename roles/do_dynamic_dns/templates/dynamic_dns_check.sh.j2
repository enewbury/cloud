#!/bin/bash

TOKEN="{{ digital_ocean_token }} "
DOMAIN="{{ digital_ocean_root_domain }}"
RECORD_ID="{{ digital_ocean_record_id }}"
LOG_FILE="{{ dynamic_dns_dir }}/public_ip.txt"

CURRENT_IPV4="$(dig +short myip.opendns.com @resolver1.opendns.com)"
LAST_IPV4="$(tail -1 $LOG_FILE | awk -F, '{print $2}')"

if [ "$CURRENT_IPV4" = "$LAST_IPV4" ]; then
    echo "IP has not changed ($CURRENT_IPV4)"
else
    echo "IP has changed: $CURRENT_IPV4"
    echo "$(date),$CURRENT_IPV4" >> "$LOG_FILE"
    curl -X PUT -H "Content-Type: application/json" -H "Authorization: Bearer $TOKEN" -d '{"data":"'"$CURRENT_IPV4"'"}' "https://api.digitalocean.com/v2/domains/$DOMAIN/records/$RECORD_ID"
    docker restart turnserver
    {% if talk_install|bool %}
    docker stop turn_server
    docker rm turnserver
    docker run -d --name turn_server \
               --retart-policy 'unless-stopped'
               -v turnserver-data-vol:/var/lib/coturn:rw \
               -v {{nextcloud_config_dir }}/turnserver.conf:/etc/coturn/turnserver.conf \
               -p 0.0.0.0:3478:3478/udp \
               -p 0.0.0.0:3478:3478/tcp \
               instrumentisto/coturn:{{ docker_turnserver_image | default('latest') }} --external-ip=$CURRENT_IPV4
    {% endif %}
fi